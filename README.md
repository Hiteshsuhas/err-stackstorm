# err-stackstorm
A plugin to run Stackstorm actions, bringing Stackstorm's chatops to errbot.


## Installation
Installation of the err-stackstorm plugin is performed from within a running errbot instance.  Ensure errbot is up and running before attempting to install the plugin.  See the errbot installation documentation here https://github.com/errbotio/errbot for instructions on how to setup errbot.

The below command will install the plugin.
```
!repos install https://github.com/fmnisme/err-stackstorm.git
```

## Requirements
The plugin has been developed and tested against the below software.  For optimal operation it is recommended to use the following versions:
 - Python >3.4
 - errbot >4.3
 - stackstorm client >2.2


## Configuration
Edit the `config.py` configuration file which is used to describe how the plugin will communicate with Stackstorm's API and authentication end points.
If you followed the errbot setup documentation this file will have been created by downloading a template from the errbot github site.   If this file has not already been created, please create it following the instructions at https://github.com/errbotio/errbot

### Authentication
The errbot plugin must have valid credentials to use Stackstorm's API.  The credentials may be;

 - username/password
 - user token
 - api key

See https://docs.stackstorm.com/authentication.html for more details.

#### Username/Password
Using a username and password will allow errbot to renew the user token when it expires.  If a _User Token_ is supplied, it will be used in preference to username/password authentication until the token expires.

#### User Token
To avoid using the username/password pair in a configuration file, it's possible to supply a pre-generated _User Token_ as generated by StackStorm.  Note when the token expires, a new one must be generated and updated in `config.py` which in turn requires errbot to be restarted.
As such, this solution may not be ideal for production environments.

#### API Key
_API Key_ support has been included since Stackstorm v2.0.  When an _API Key_ is provided, it is used in preference to a _User Token_ or _username/password_ pair.  It is considered a mistake to supply a token or username/password pair when using the API Key.

```
STACKSTORM = {
    'base_url': 'https://stackstorm.example.com',
    'auth_url': 'https://stackstorm.example.com/auth',
    'api_url': 'https://stackstorm.example.com/api/v1',
    'stream_url': 'https://stackstorm.example.com/stream/v1',
    'api_version': 'v1',
    'api_auth': {
        'user': {
            'name': 'my_username',
            'password': "my_password",
        },
        'token': "<User token>",
        'key': '<API Key>'
    },
    'timer_update': 900, #  Unit: second.  Interval for errbot to refresh to list of available action aliases.
}
```


## How to expose action-aliases as plugin commands
 1. Connect errbot to your chat environment.
 2. Write an action alias in Stackstorm.
 3. Either restart errbot or wait for the refresh interval for errbot to update the action alias list.
 4. Type `!st2help` in your chat program for the list of available commands.
 5. Type the desired command in your chat program, as shown in the help.


## Authentication
Authentication is possible with username/password, User Token or API Key.  In the case of a username and password, the plugin is able to request a new User Token after it expires.  In the case of a User Token or API Key, once it expires, the errbot plugin will no longer have access to the st2 API.


## Send messages from Stackstorm to Errbot using Errbot's native webhook support

Errbot has a built in webserver which is configured and enabled through the bots admin chat interface.  The Stackstorm plugin is written to listen for Stackstorm's chatops messages and delivers them to the attached chat backend.

To configure errbot's webserver plugin, the command below can sent to errbot.
```
!plugin config Webserver {'HOST': '0.0.0.0',
'PORT': 8888,
'SSL': {'certificate': '',
'enabled': False,
'host': '0.0.0.0',
'key': '',
'port': 8889}}
```
**NOTE:** _The variables must be adjusted to match the operating environment in which errbot is running._

Enable to webserver plugin.
```
!plugin activate Webserver
```


## Send notifications to Errbot from Stackstorm using Server-Side Events (SSE)

As of Stackstorm 1.4. server-sent events (SSE) were added which allowed certain chatops messages to be
streamed from Stackstorm to Errbot.  The Stackstorm stream url must be supplied in the configuration
to use SSE.  The SSE configuration is complementry to the webhook method and both must be enabled
for full chatops support between Stackstorm and Errbot.

